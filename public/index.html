<!DOCTYPE html>
<html>
  <head>
    <title>Conjur UI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="http://fb.me/react-0.8.0.js"></script>
    <script src="http://fb.me/JSXTransformer-0.8.0.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/showdown/0.3.1/showdown.min.js"></script>
    <script src="http://code.jquery.com/jquery-1.10.0.min.js"></script>
    <script src="/js/lib/bootstrap.min.js"></script>
    <script src="/js/lib/underscore-min.js"></script>
  </head>
<body>
    <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container">
      </div>
    </div>

    <div class="container" style="margin-top: 60px;">

      <div id="content"></div>

    </div><!-- /.container -->
  
    <script type="text/jsx" src="/js/views/namespace.js"></script>
    <script type="text/jsx" src="/js/views/group.js"></script>
    <script type="text/jsx" src="/js/views/groupBox.js"></script>
    <script type="text/jsx">
/**
 * @jsx React.DOM
 */
var currentNamespace = "";
var globalGroups = null;
var component = null;

function parseGroups(callback) {
  var groups;
  if ( currentNamespace === "" ) {
    groups = globalGroups;
  }
  else {
    groups = globalGroups.filter(function (group) {
      return group.id.split('/')[0] === currentNamespace;
    });
  }
  groups = _.clone(groups).sort(function(a,b) {
    return a.id.localeCompare(b.id);
  });
  var namespaces = _.unique(globalGroups.map(function (group) {
    return group.id.split('/')[0];
  })).sort();
  callback(namespaces, groups);
}

function fetchGroups(callback) {
  if ( globalGroups )
    return parseGroups(callback);
    
  $.ajax({
    url: "/api/groups",
    success: function(data) {
      globalGroups = data;
      parseGroups(callback);
    }
  });
}

function updateGroups(namespace) {
  currentNamespace = namespace;
  fetchGroups(function(namespaces, groups) {
    component.setState({currentNamespace: currentNamespace, groups: groups});
  });
}
      
$(document).ready(function() {
  fetchGroups(function(namespaces, groups) {
    component = <GroupBox data={{namespaces: namespaces}} />;
    React.renderComponent(
      component,
      document.getElementById('content')
    );
    component.setState({currentNamespace: currentNamespace, groups: groups});
  });
});
    </script>
  </body>
</html>